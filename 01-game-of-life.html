<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game of Life</title>

    <style>
        body {
            background-color: black;
            color: white;
            font-family: monospace;
        }

        main,
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
        }


        canvas {
            border: 2px solid white;

            --color-alive: white;
            --color-dead: darkgray;
        }

        .cool-theme {
            --color-alive: cyan;
            --color-dead: color-mix(in srgb, cyan 20%, transparent);
        }
    </style>

    <script>
        class GameGrid {
            constructor({ rows, cols, cell }) {
                this.rows = rows
                this.cols = cols
                this.vals = []

                for (let row = 0; row < rows; row++) {
                    this.vals[row] = [];
                    for (let col = 0; col < cols; col++) {
                        // Ask the cellFunction what should be here
                        this.vals[row][col] = cell(row, col);
                    }
                }
            }

            getVal({ row, col }) {
                if (0 <= row && row < this.rows && 0 <= col && col < this.cols) {
                    return this.vals[row][col]
                }

                return undefined
            }

            getCell({ row, col }) {
                return {
                    row: row,
                    col: col,
                    val: this.getVal({
                        row: row,
                        col: col
                    })
                }
            }

            setCell({ row, col, val }) {
                if (0 <= row && row < this.rows && 0 <= col && col < this.cols) {
                    this.vals[row][col] = val
                }
            }
        }

        GameGrid.zero = ({ rows, cols }) => new GameGrid({
            rows: rows,
            cols: cols,
            cell: () => 0
        })
    </script>

    <script>
        class ConsoleRenderer {
            constructor({ alive, dead }) {
                this.alive = alive
                this.dead = dead
            }

            render(grid) {
                let output = ''

                for (let row = 0; row < grid.rows; row++) {
                    for (let col = 0; col < grid.cols; col++) {
                        if (grid.getVal({ row: row, col: col })) {
                            output = output + this.alive;  // alive
                        } else {
                            output = output + this.dead;  // dead
                        }
                    }
                    output = output + '\n';
                }

                console.log(output)
            }
        }
    </script>

    <script>
        class CanvasRenderer {
            constructor({ canvas, tileSize }) {
                this.canvas = canvas
                this.tileSize = tileSize
                this.context = canvas.getContext('2d')
            }

            centerInCell({ row, col, draw }) {
                this.context.save()
                this.context.translate(
                    row * this.tileSize + this.tileSize / 2,
                    col * this.tileSize + this.tileSize / 2
                )

                draw()
                this.context.restore()
            }

            fillQuad(size) {
                this.context.beginPath()
                this.context.roundRect(-size / 2, -size / 2, size, size, size / 4)
                this.context.fill()
                this.context.closePath()
            }

            fillTile() {
                this.fillQuad(this.tileSize)
            }

            render(grid) {
                this.context.reset()
                const style = getComputedStyle(this.canvas)
                const colorAlive = style.getPropertyValue('--color-alive')
                const colorDead = style.getPropertyValue('--color-dead')

                for (let row = 0; row < grid.rows; row++) {
                    for (let col = 0; col < grid.cols; col++) {
                        this.centerInCell({
                            row: row,
                            col: col,
                            draw: () => {

                                if (grid.getVal({ row: row, col: col })) {
                                    this.context.fillStyle = colorAlive
                                } else {
                                    this.context.fillStyle = colorDead
                                }

                                this.fillQuad(this.tileSize - 2)
                            }
                        })
                    }
                }
            }
        }

        CanvasRenderer.auto = ({ rows, cols, tileSize }) => {
            const canvas = document.createElement('canvas')
            canvas.width = rows * tileSize
            canvas.height = cols * tileSize

            return new CanvasRenderer({
                canvas: canvas,
                tileSize: tileSize
            })
        }
    </script>

    <script>
        function updateGameOfLife(grid) {
            return new GameGrid({
                rows: grid.rows,
                cols: grid.cols,
                cell: (row, col) => {
                    // Count alive neighbors
                    let aliveNeighbors = 0;
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            if (dr === 0 && dc === 0) continue; // Skip self
                            const val = grid.getVal({ row: row + dr, col: col + dc });
                            if (val) aliveNeighbors++;
                        }
                    }

                    const isAlive = grid.getVal({ row, col });

                    // Game of Life rules
                    if (isAlive) {
                        return aliveNeighbors === 2 || aliveNeighbors === 3;
                    } else {
                        return aliveNeighbors === 3;
                    }
                }
            })
        }
    </script>

    <script>
        class GameLoop {
            constructor({ launch, render, update }) {
                this.launch = launch
                this.render = render
                this.update = update
            }

            run() {
                let state = this.launch()
                this.render(state)

                let next = () => {
                    console.log("Next Frame")
                    state = this.update(state)
                    this.render(state)
                }

                console.log("Start run")
                setInterval(next, 1000)
            }
        }
    </script>
    <script>
        class HtmlRenderer {
            constructor({ parent, template }) {
                this.parent = parent
                this.template = template
            }

            render(state) {
                this.parent.innerHTML = this.template(state)
            }
        }

        HtmlRenderer.append = ({ parent, template }) => {
            let div = document.createElement('div')
            parent.append(div)
            return new HtmlRenderer({
                parent: div,
                template: template
            })
        }
    </script>
</head>

<body>
    <header>
        <h1>Game of Life</h1>
    </header>

    <main>
        <canvas id="view" width="120" height="120"></canvas>
    </main>
    <script>

        const deadGrid = GameGrid.zero({
            rows: 5,
            cols: 5
        })

        const randomGrid = new GameGrid({
            rows: 5,
            cols: 5,
            cell: () => Math.random() <= 0.5
        })

        const asciiRenderer = new ConsoleRenderer({
            alive: '1',
            dead: '0'
        })

        const emojiRenderer = new ConsoleRenderer({
            alive: 'ðŸ˜€',
            dead: 'ðŸ˜´'
        })

        console.log("=== Dead Grid with Ascii ===")
        asciiRenderer.render(deadGrid)

        console.log("=== Random Grid with Ascii ===")
        asciiRenderer.render(randomGrid)

        console.log("=== Random Grid with Emoji===")
        emojiRenderer.render(randomGrid)


        const canvasRenderer = new CanvasRenderer({
            canvas: document.getElementById('view'),
            tileSize: 16
        })

        canvasRenderer.render(randomGrid)

        const autoRenderer = CanvasRenderer.auto({
            rows: 24,
            cols: 32,
            tileSize: 16
        })


        const main = document.querySelector('main')
        main.append(
            autoRenderer.canvas
        )

        autoRenderer.canvas.classList.add('cool-theme')


        statsRenderer = HtmlRenderer.append({
            parent: main,
            template: (grid) => {
                let alive = 0

                for (let row = 0; row < grid.rows; row++) {
                    for (let col = 0; col < grid.cols; col++) {
                        if (grid.getVal({ row: row, col: col })) {
                            alive += 1
                        }
                    }
                }

                return `\
                <table>
                    <tbody>
                        <tr>
                            <th>Cells Alive:</th>
                            <td>${alive}</td>
                        </tr>
                        <tr>
                            <th>Chances of Survival:</th>
                            <td>${Math.round(alive / (grid.rows * grid.cols) * 100)}%</td>
                        </tr>
                    </tbody>
                </table>
                `
            }
        })

        const loop = new GameLoop({
            launch: () => new GameGrid({
                rows: 24,
                cols: 32,
                cell: () => Math.random() <= 0.5
            }),
            render: (state) => {
                asciiRenderer.render(state)
                autoRenderer.render(state)
                statsRenderer.render(state)
            },
            update: updateGameOfLife
        })

        loop.run()
    </script>
</body>

</html>