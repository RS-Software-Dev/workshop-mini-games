<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>

    <link rel="stylesheet" href="style.css">
    <style>
        canvas {
            --color-snake: lime;
            --color-food: red;
            --color-empty: #111;
        }


        button {
            background-color: inherit;
            color: white;
            border: 2px solid white;
            padding: 16px 24px;
            font-family: monospace;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #333333;
        }

        .game-over {
            color: red;
            font-size: 24px;
            font-weight: bold;
        }
    </style>

    <script src="scripts/GameGrid.js"></script>
    <script src="scripts/ConsoleRenderer.js"></script>
    <script src="scripts/CanvasRenderer.js"></script>
    <script src="scripts/HtmlRenderer.js"></script>
    <script src="scripts/MiniGame.js"></script>



    <script>
        class SnakeState {
            constructor({ rows, cols }) {
                this.rows = rows
                this.cols = cols
                this.snake = [
                    { row: Math.floor(rows / 2), col: Math.floor(cols / 2) }
                ]
                this.direction = { row: 0, col: 1 } // Start moving right
                this.nextDirection = { row: 0, col: 1 }
                this.food = this.spawnFood()
                this.gameOver = true
                this.score = 0
            }

            spawnFood() {
                let food;
                do {
                    food = {
                        row: Math.floor(Math.random() * this.rows),
                        col: Math.floor(Math.random() * this.cols)
                    }
                } while (this.isSnakeAt(food.row, food.col))
                return food
            }

            isSnakeAt(row, col) {
                return this.snake.some(seg => seg.row === row && seg.col === col)
            }
        }
    </script>

    <script>
        function updateSnake(state) {
            if (state.gameOver) return state

            const newState = new SnakeState({ rows: state.rows, cols: state.cols })
            newState.snake = [...state.snake]
            newState.direction = state.nextDirection
            newState.nextDirection = state.nextDirection
            newState.food = state.food
            newState.score = state.score

            // Calculate new head position
            const head = newState.snake[0]
            const newHead = {
                row: head.row + newState.direction.row,
                col: head.col + newState.direction.col
            }

            // Wrap around edges
            if (newHead.row < 0) newHead.row = newState.rows - 1
            if (newHead.row >= newState.rows) newHead.row = 0
            if (newHead.col < 0) newHead.col = newState.cols - 1
            if (newHead.col >= newState.cols) newHead.col = 0

            // Check self collision
            if (newState.isSnakeAt(newHead.row, newHead.col)) {
                newState.gameOver = true
                return newState
            }

            // Add new head
            newState.snake.unshift(newHead)

            // Check food collision
            if (newHead.row === newState.food.row && newHead.col === newState.food.col) {
                newState.food = newState.spawnFood()
                newState.score++
            } else {
                // Remove tail if no food eaten
                newState.snake.pop()
            }

            return newState
        }
    </script>



    <script>
        class SnakeCellRenderer {
            /*constructor({ canvas }) {
                this.canvas = canvas
            }

            setup(context, canvas) {
                const style = getComputedStyle(canvas)
                this.colorSnake = style.getPropertyValue('--color-snake')
                this.colorFood = style.getPropertyValue('--color-food')
            }*/

            render(cell, context, helpers) {
                if (cell === 'empty') return

                if (cell === 'snake') {
                    context.fillStyle = 'lime'
                } else if (cell === 'food') {
                    context.fillStyle = 'red'
                }

                helpers.fillQuad(helpers.tileSize - 2)
            }
        }
    </script>

    <script>
        class GameLoop {
            constructor({ launch, render, update, tickRate }) {
                this.launch = launch
                this.render = render
                this.update = update
                this.tickRate = tickRate || 1000
                this.intervalId = null
                this.state = null
            }

            run() {
                this.state = this.launch()
                this.render(this.state)

                let next = () => {
                    this.state = this.update(this.state)
                    this.render(this.state)

                    if (this.state.gameOver && this.intervalId) {
                        clearInterval(this.intervalId)
                        this.intervalId = null
                    }
                }

                this.intervalId = setInterval(next, this.tickRate)
            }

            stop() {
                if (this.intervalId) {
                    clearInterval(this.intervalId)
                    this.intervalId = null
                }
            }

            restart() {
                this.stop()
                this.run()
            }
        }
    </script>
</head>

<body>
    <header>
        <h1>Snake Game</h1>
        <p>Use Arrow Keys or WASD to move</p>
    </header>

    <main>
    </main>

    <script>
        const ROWS = 20
        const COLS = 30
        const TILE_SIZE = 20

        const main = document.querySelector('main')

        function drawFood({ row, col }) {
            this.save()
            this.translate(
                col * TILE_SIZE + TILE_SIZE / 2,
                row * TILE_SIZE + TILE_SIZE / 2
            )

            this.fillStyle = "red"

            this.beginPath()
            this.arc(0, 0, TILE_SIZE / 2, 0, 2 * Math.PI)
            this.fill()

            this.restore()
        }

        function drawSnake(snake) {
            for (const { row, col } of snake) {
                this.save()
                this.translate(
                    col * TILE_SIZE + TILE_SIZE / 2,
                    row * TILE_SIZE + TILE_SIZE / 2
                )

                this.fillStyle = "lime"
                this.beginPath()
                this.roundRect(
                    -TILE_SIZE / 2,
                    -TILE_SIZE / 2,
                    TILE_SIZE,
                    TILE_SIZE,
                    TILE_SIZE / 4
                )
                this.fill()

                this.restore()
            }
        }

        const canvasRenderer = CanvasRenderer.createInside({
            parent: main,
            width: COLS * TILE_SIZE,
            height: ROWS * TILE_SIZE,
            draw: function (state) {

                drawFood.bind(this)(state.food)
                drawSnake.bind(this)(state.snake)
            }
        })

        const statsRenderer = HtmlRenderer.append({
            parent: main,
            template: (state) => {
                return `
                <div>
                    <span>Score:</span>
                    <span>${state.score}</span>
                </div>
                ${state.gameOver ?
                    '<span class="game-over">Game Over</span>' :
                    ''
                }
                `

                /*
                return `
                <table>
                    <tbody>
                        <tr>
                            <th>Score:</th>
                            <td>${state.score}</td>
                        </tr>
                        <tr>
                            <th>Snake Length:</th>
                            <td>${state.snake.length}</td>
                        </tr>
                        ${state.gameOver ? '<tr><td colspan="2" class="game-over">GAME OVER!</td></tr>' : ''}
                    </tbody>
                </table>
                ${state.gameOver ? '<button id="restart-btn">Restart Game</button>' : ''}
                `
                */
            }
        })

        const loop = new GameLoop({
            launch: () => new SnakeState({ rows: ROWS, cols: COLS }),
            render: (state) => {
                canvasRenderer.render(state)
                statsRenderer.render(state)

                // Attach restart handler if game over
                if (state.gameOver) {
                    const btn = document.getElementById('restart-btn')
                    if (btn) {
                        btn.onclick = () => loop.restart()
                    }
                }
            },
            update: updateSnake,
            tickRate: 150
        })

        // Input handling
        document.addEventListener('keydown', (e) => {
            if (!loop.state || loop.state.gameOver) return

            const key = e.key.toLowerCase()
            const dir = loop.state.direction

            // Prevent reversing direction
            if ((key === 'arrowup' || key === 'w') && dir.row !== 1) {
                loop.state.nextDirection = { row: -1, col: 0 }
            } else if ((key === 'arrowdown' || key === 's') && dir.row !== -1) {
                loop.state.nextDirection = { row: 1, col: 0 }
            } else if ((key === 'arrowleft' || key === 'a') && dir.col !== 1) {
                loop.state.nextDirection = { row: 0, col: -1 }
            } else if ((key === 'arrowright' || key === 'd') && dir.col !== -1) {
                loop.state.nextDirection = { row: 0, col: 1 }
            }
        })

        loop.run()
    </script>
</body>

</html>