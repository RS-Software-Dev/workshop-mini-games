<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>

    <link rel="stylesheet" href="style.css">
    <style>
        canvas {
            --color-snake: lime;
            --color-food: red;
            --color-empty: #111;
        }


        button {
            background-color: inherit;
            color: white;
            border: 2px solid white;
            padding: 16px 24px;
            font-family: monospace;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #333333;
        }

        .game-over {
            color: red;
            font-size: 24px;
            font-weight: bold;
        }
    </style>

    <script src="scripts/GameGrid.js"></script>
    <script src="scripts/ConsoleRenderer.js"></script>
    <script src="scripts/CanvasRenderer.js"></script>
    <script src="scripts/HtmlRenderer.js"></script>
    <script src="scripts/MiniGame.js"></script>



    <script>
        class SnakeState {
            constructor({ rows, cols }) {
                this.rows = rows
                this.cols = cols
                this.snake = [
                    { row: Math.floor(rows / 2), col: Math.floor(cols / 2) }
                ]
                this.direction = { row: 0, col: 1 } // Start moving right
                this.nextDirection = { row: 0, col: 1 }
                this.food = this.spawnFood()
                this.gameOver = false
                this.score = 0
            }

            spawnFood() {
                let food;
                do {
                    food = {
                        row: Math.floor(Math.random() * this.rows),
                        col: Math.floor(Math.random() * this.cols)
                    }
                } while (this.isSnakeAt(food.row, food.col))
                return food
            }

            isSnakeAt(row, col) {
                return this.snake.some(seg => seg.row === row && seg.col === col)
            }
        }
    </script>

    <script>
        function updateSnake(state) {
            if (state.gameOver) return state

            const newState = new SnakeState({ rows: state.rows, cols: state.cols })
            newState.snake = [...state.snake]
            newState.direction = state.nextDirection
            newState.nextDirection = state.nextDirection
            newState.food = state.food
            newState.score = state.score

            // Calculate new head position
            const head = newState.snake[0]
            const newHead = {
                row: head.row + newState.direction.row,
                col: head.col + newState.direction.col
            }

            // Wrap around edges
            if (newHead.row < 0) newHead.row = newState.rows - 1
            if (newHead.row >= newState.rows) newHead.row = 0
            if (newHead.col < 0) newHead.col = newState.cols - 1
            if (newHead.col >= newState.cols) newHead.col = 0

            // Check self collision
            if (newState.isSnakeAt(newHead.row, newHead.col)) {
                newState.gameOver = true
                return newState
            }

            // Add new head
            newState.snake.unshift(newHead)

            // Check food collision
            if (newHead.row === newState.food.row && newHead.col === newState.food.col) {
                newState.food = newState.spawnFood()
                newState.score++
            } else {
                // Remove tail if no food eaten
                newState.snake.pop()
            }

            return newState
        }

        function tickSnake(state) {
            return state.gameOver ? state : updateSnake(state)
        }
    </script>


    <script>
        class GameLoop {
            constructor({ launch, render, update, tickRate }) {
                this.launch = launch
                this.render = render
                this.update = update
                this.tickRate = tickRate || 1000
                this.intervalId = null
                this.state = null
            }

            run() {
                this.state = this.launch()
                this.render(this.state)

                let next = () => {
                    this.state = this.update(this.state)
                    this.render(this.state)

                    if (this.state.gameOver && this.intervalId) {
                        clearInterval(this.intervalId)
                        this.intervalId = null
                    }
                }

                this.intervalId = setInterval(next, this.tickRate)
            }

            stop() {
                if (this.intervalId) {
                    clearInterval(this.intervalId)
                    this.intervalId = null
                }
            }

            restart() {
                this.stop()
                this.run()
            }
        }
    </script>
</head>

<body>
    <header>
        <h1>Snake Game</h1>
        <p>Use Arrow Keys or WASD to move</p>
    </header>

    <main>
    </main>

    <script>
        const ROWS = 20
        const COLS = 30
        const TILE_SIZE = 20

        const main = document.querySelector('main')

        function drawFood({ row, col }) {
            this.save()
            this.translate(
                col * TILE_SIZE + TILE_SIZE / 2,
                row * TILE_SIZE + TILE_SIZE / 2
            )

            this.fillStyle = "red"

            this.beginPath()
            this.arc(0, 0, TILE_SIZE / 2, 0, 2 * Math.PI)
            this.fill()

            this.restore()
        }

        function drawSnake(snake) {
            for (const { row, col } of snake) {
                this.save()
                this.translate(
                    col * TILE_SIZE + TILE_SIZE / 2,
                    row * TILE_SIZE + TILE_SIZE / 2
                )

                this.fillStyle = "lime"
                this.beginPath()
                this.roundRect(
                    -TILE_SIZE / 2,
                    -TILE_SIZE / 2,
                    TILE_SIZE,
                    TILE_SIZE,
                    TILE_SIZE / 4
                )
                this.fill()

                this.restore()
            }
        }

        const canvasRenderer = CanvasRenderer.createInside({
            parent: main,
            width: COLS * TILE_SIZE,
            height: ROWS * TILE_SIZE,
            draw: function (state) {

                drawFood.bind(this)(state.food)
                drawSnake.bind(this)(state.snake)
            }
        })

        const statsRenderer = HtmlRenderer.append({
            parent: main,
            template: (state) => {
                return `
                ${state.gameOver ?
                        '<span class="game-over">Game Over</span>' :
                        ''
                    }
                <div>
                    <span>Score:</span>
                    <span>${state.score}</span>
                </div>
                ${state.gameOver ? '<button id="restart-btn">Restart Game</button>' : ''}
                `
            }
        })

        /*
        const loop = new GameLoop({
            launch: () => new SnakeState({ rows: ROWS, cols: COLS }),
            render: (state) => {
                canvasRenderer.render(state)
                statsRenderer.render(state)

                // Attach restart handler if game over
                if (state.gameOver) {
                    const btn = document.getElementById('restart-btn')
                    if (btn) {
                        btn.onclick = () => loop.restart()
                    }
                }
            },
            update: updateSnake,
            tickRate: 150
        })
            */

        const game = new MiniGame({
            state: new SnakeState({
                rows: ROWS,
                cols: COLS
            }),
            render: (state) => {
                canvasRenderer.render(state)
                statsRenderer.render(state)

                // Attach restart handler if game over
                if (state.gameOver) {
                    const btn = document.getElementById('restart-btn')
                    if (btn) {
                        btn.onclick = () => loop.restart()
                    }
                }
            },
            update: (state, event) => {
                if (event instanceof MoveEvent) {
                    const prev = state.direction
                    const next = event.direction

                    if (prev.row + next.row != 0 || prev.col + next.col != 0) {
                        console.log("Change direction")
                        state.nextDirection = next
                    }

                    return state
                }
                else {
                    return updateSnake(state)
                }

            }
        })

        class MoveEvent {
            constructor(value) {
                this.value = value
            }

            static UP = new MoveEvent('up')
            static LEFT = new MoveEvent('left')
            static RIGHT = new MoveEvent('right')
            static DOWN = new MoveEvent('down')

            get rowDirection() {
                return this.value == "down" ? 1 :
                    this.value == "up" ? -1 : 0
            }

            get colDirection() {
                return this.value == "right" ? 1 :
                    this.value == "left" ? -1 : 0
            }

            get direction() {
                return {
                    row: this.rowDirection,
                    col: this.colDirection
                }
            }
        }

        game.run(150)

        // Input handling
        document.addEventListener('keydown', (e) => {
            if (!game.state || game.state.gameOver) return

            switch (e.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    game.update(MoveEvent.UP)
                    break
                case 's':
                case 'arrowdown':
                    game.update(MoveEvent.DOWN)
                    break
                case 'a':
                case 'arrowleft': 
                    game.update(MoveEvent.LEFT)
                    break
                case 'd':
                case 'arrowright': 
                    game.update(MoveEvent.RIGHT)
                    break
            }
        })
    </script>
</body>

</html>